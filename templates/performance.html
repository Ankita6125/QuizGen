{% extends "base.html" %}
{% load custom_filters %}
{% block title %}Dashboard - QuizGen{% endblock %}

{% block content %}
<div class="container mx-auto p-6 space-y-12">

  <!-- Row 1: Welcome -->
  <div class="text-center">
    <h1 class="text-3xl font-extrabold text-indigo-700">
      ğŸ‘‹ Welcome back, {{ request.user.email }}!
    </h1>
    <p class="text-gray-600 mt-2">Ready to continue your learning journey?</p>
  </div>

  <!-- Row 2: Stats Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-gradient-to-r from-pink-500 to-pink-600 p-6 rounded-2xl shadow-lg text-center">
      <h2 class="text-4xl font-bold text-white">ğŸ“Š {{ total_quizzes }}</h2>
      <p class="text-indigo-100">Total Quizzes</p>
    </div>
    <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 rounded-2xl shadow-lg text-center">
      <h2 class="text-4xl font-bold text-white">ğŸ† {{ avg_score }}%</h2>
      <p class="text-green-100">Average Score</p>
    </div>
    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-center">
      <h2 class="text-4xl font-bold text-white">ğŸ”¥ {{ best_score }}%</h2>
      <p class="text-yellow-100">Best Score</p>
    </div>
    <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 p-6 rounded-2xl shadow-lg text-center">
      <h2 class="text-4xl font-bold text-white">âš¡ {{ streak_days }}</h2>
      <p class="text-pink-100">Current Streak (Days)</p>
    </div>
  </div>

  <!-- Row 3: Quick Actions -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <a href="{% url 'categories' %}" class="bg-indigo-100 p-6 rounded-2xl shadow hover:bg-indigo-200 text-center">
      ğŸ“ Start New Quiz
    </a>
    <a href="{% url 'history' %}" class="bg-yellow-100 p-6 rounded-2xl shadow hover:bg-yellow-200 text-center">
      ğŸ“š Quiz History
    </a>
  </div>

  <!-- Row 4: Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="bg-white rounded-2xl shadow p-6 h-[400px]">
      <h3 class="text-lg font-semibold mb-4">ğŸ“ˆ Performance Over Time</h3>
      <canvas id="performanceChart" class="w-full h-full"></canvas>
    </div>
    <div class="bg-white rounded-2xl shadow p-6 h-[400px]">
      <h3 class="text-lg font-semibold mb-4">ğŸ“Š Category Performance</h3>
      <canvas id="categoryChart" class="w-full h-full"></canvas>
    </div>
  </div>

  <!-- Row 5: Detailed Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-red-100 p-6 rounded-2xl shadow text-center">
      <h3 class="text-lg font-semibold">ğŸ¯ Accuracy Rate</h3>
      <p class="text-3xl font-bold text-indigo-600 mt-2">{{ accuracy_rate }}%</p>
      <p class="text-green-600 text-sm mt-2">+{{ accuracy_improvement }}% this week</p>
    </div>
    <div class="bg-orange-100 p-6 rounded-2xl shadow text-center">
      <h3 class="text-lg font-semibold">â± Avg. Time/Question</h3>
      <p class="text-3xl font-bold text-indigo-600 mt-2">{{ avg_time_per_question }}s</p>
      <p class="text-gray-600 text-sm mt-2">Optimal range</p>
    </div>
    <div class="bg-purple-100 p-6 rounded-2xl shadow text-center">
      <h3 class="text-lg font-semibold">ğŸ’ª Strongest Subject</h3>
      <p class="text-3xl font-bold text-green-600 mt-2">{{ strongest_subject }}</p>
      <p class="text-gray-600 text-sm mt-2">{{ strongest_score }}% average</p>
    </div>
  </div>

  <!-- Row 6: Category Performance + Recent Activity -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: Category Performance -->
    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow">
      <h3 class="text-lg font-bold mb-4">ğŸ¯ Category Performance</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for category in categories %}
          {% cycle 'card-color-1' 'card-color-2' 'card-color-3' 'card-color-4' 'card-color-5' 'card-color-6' as card_color silent %}
          <div class="p-4 rounded-xl {{ card_color }} transition transform hover:scale-105">
            <h4 class="font-bold">ğŸ“Œ {{ category.name }}</h4>
            <p class="text-sm text-gray-600">{{ category.description }}</p>
            <p class="text-sm mt-2 text-gray-500">
              {{ attempts_dict|get_item:category.id|default:0 }} quizzes attempted
            </p>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right: Recent Activity -->
    <div class="bg-white p-6 rounded-2xl shadow">
      <h3 class="text-lg font-bold mb-4">ğŸ•’ Recent Activity</h3>
      <ul class="divide-y divide-gray-200">
        {% for h in recent_history %}
          <li class="py-3 flex justify-between items-center hover:bg-gray-50 px-2 rounded">
            <span>{{ h.quiz.title }} - {{ h.completed_at|date:"M d, Y H:i" }}</span>
            <span class="font-semibold px-3 py-1 rounded-full text-sm
              {% if h.score >= 80 %} bg-green-100 text-green-700
              {% elif h.score >= 50 %} bg-yellow-100 text-yellow-700
              {% else %} bg-red-100 text-red-700
              {% endif %}">
              {{ h.score }}%
            </span>
          </li>
        {% empty %}
          <li class="py-3 text-gray-500">No recent activity</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Row 7: Personalized Recommendations -->
  <div class="bg-white rounded-2xl shadow p-8">
    <h3 class="text-xl font-bold mb-6">ğŸ¯ Personalized Recommendations</h3>
    <div class="grid md:grid-cols-3 gap-6">
      <div class="p-5 bg-yellow-50 rounded-xl border border-yellow-200 hover:shadow-md transition">
        <h4 class="font-semibold">ğŸ“š Focus on {{ weak_subject }}</h4>
        <p class="text-sm text-gray-600 mt-2">
          Your {{ weak_subject }} scores are below average. Practice more here.
        </p>
        <a href="{% url 'categories' %}?focus={{ weak_subject }}" class="inline-block mt-3 text-yellow-700 font-medium hover:underline">
          Start Quiz â†’
        </a>
      </div>

      <div class="p-5 bg-green-50 rounded-xl border border-green-200 hover:shadow-md transition">
        <h4 class="font-semibold">ğŸ”¥ Maintain Your Streak</h4>
        <p class="text-sm text-gray-600 mt-2">
          You're on a {{ streak_days }}-day streak! Take at least one quiz today.
        </p>
        <a href="{% url 'categories' %}" class="inline-block mt-3 text-green-700 font-medium hover:underline">
          Continue Streak â†’
        </a>
      </div>

      <div class="p-5 bg-blue-50 rounded-xl border border-blue-200 hover:shadow-md transition">
        <h4 class="font-semibold">ğŸ’¡ Challenge Yourself</h4>
        <p class="text-sm text-gray-600 mt-2">
          Excelling in {{ strongest_subject }}? Try harder levels now.
        </p>
        <a href="{% url 'categories' %}?difficulty=hard" class="inline-block mt-3 text-blue-700 font-medium hover:underline">
          Take Hard Quiz â†’
        </a>
      </div>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx1 = document.getElementById('performanceChart');
new Chart(ctx1, {
  type: 'line',
  data: {
    labels: {{ performance_labels|safe }},
    datasets: [{
      label: 'Score %',
      data: {{ performance_scores|safe }},
      borderColor: '#6366f1',
      backgroundColor: 'rgba(99,102,241,0.1)',
      fill: true,
      tension: 0.4,
      borderWidth: 2,
      pointBackgroundColor: '#4f46e5'
    }]
  },
  options: { 
    responsive: true, 
    maintainAspectRatio: false,
    plugins: { legend: { display: false } }
  }
});

const ctx2 = document.getElementById('categoryChart');
new Chart(ctx2, {
  type: 'doughnut',
  data: {
    labels: {{ category_labels|safe }},
    datasets: [{
      label: 'Category Score %',
      data: {{ category_scores|safe }},
      backgroundColor: ['#34d399','#60a5fa','#fbbf24','#f87171','#a78bfa'],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: { 
    responsive: true, 
    maintainAspectRatio: false,
    plugins: { legend: { position: 'bottom' } }
  }
});
</script>

<!-- Styles for Category Cards -->
<style>
.card-color-1 { background: linear-gradient(135deg, rgba(236,72,153,0.15), rgba(244,114,182,0.15)); border: 2px solid #ec4899; }
.card-color-2 { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(74,222,128,0.15)); border: 2px solid #22c55e; }
.card-color-3 { background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(167,139,250,0.15)); border: 2px solid #8b5cf6; }
.card-color-4 { background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(96,165,250,0.15)); border: 2px solid #3b82f6; }
.card-color-5 { background: linear-gradient(135deg, rgba(251,191,36,0.15), rgba(253,224,71,0.15)); border: 2px solid #fbbf24; }
.card-color-6 { background: linear-gradient(135deg, rgba(244,63,94,0.15), rgba(251,113,133,0.15)); border: 2px solid #f43f5e; }
</style>
{% endblock %}
